<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë‹ˆíŠ¸ ì „ê¸°ì°¨ ì¶©ì „ê´€ì œ ì‹œìŠ¤í…œ ì˜ì—… í˜„í™©í‘œ (íŒ€ ê³µìœ )</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Malgun Gothic', sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .sync-status {
            display: inline-block;
            margin-left: 15px;
            padding: 5px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            font-size: 12px;
        }
        
        .sync-status.synced {
            background: rgba(16, 185, 129, 0.3);
        }
        
        .sync-status.syncing {
            background: rgba(251, 191, 36, 0.3);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .controls {
            background: white;
            padding: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .controls button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .controls button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .controls button.secondary {
            background: #10b981;
        }
        
        .controls button.secondary:hover {
            background: #059669;
        }
        
        .summary {
            background: white;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
        }
        
        .summary-card.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .summary-card.pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .summary-card h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .table-container {
            background: white;
            overflow-x: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 0 0 10px 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1650px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            font-size: 13px;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
            vertical-align: top;
        }
        
        tr:hover {
            background-color: #f8f9ff;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .charger-list {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .charger-item {
            background: white;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
            display: grid;
            grid-template-columns: 80px 100px auto;
            gap: 8px;
            align-items: center;
        }
        
        .charger-item .charger-details {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .charger-item input, .charger-item select {
            font-size: 12px;
            padding: 4px;
        }
        
        .charger-item .remove-charger {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .charger-item .remove-charger:hover {
            background: #dc2626;
        }
        
        .add-charger-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            margin-top: 5px;
        }
        
        .add-charger-btn:hover {
            background: #059669;
        }
        
        .charger-summary {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            font-weight: bold;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>ë°ì´í„° ë™ê¸°í™” ì¤‘...</p>
        </div>
    </div>

    <div class="header">
        <h1>âš¡ ëª¨ë‹ˆíŠ¸ ì „ê¸°ì°¨ ì¶©ì „ê´€ì œ ì‹œìŠ¤í…œ ì˜ì—… í˜„í™©í‘œ (íŒ€ ê³µìœ )</h1>
        <p>ì‹¤ì‹œê°„ íŒ€ í˜‘ì—… ì‹œìŠ¤í…œ - Google Sheets ì—°ë™
            <span class="sync-status" id="syncStatus">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
        </p>
    </div>
    
    <div class="controls">
        <button onclick="addRow()">â• ê³ ê°ì‚¬ ì¶”ê°€</button>
        <button onclick="loadFromSheets()" id="loadBtn">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
        <button onclick="saveToSheets()" id="saveBtn">ğŸ’¾ ìˆ˜ë™ ì €ì¥</button>
        <button class="secondary" onclick="exportToExcel()">ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
    
    <div class="summary">
        <div class="summary-card">
            <h3>ì „ì²´ ê³ ê°ì‚¬</h3>
            <div class="value" id="totalClients">0</div>
        </div>
        <div class="summary-card success">
            <h3>ì„±ì‚¬ ê±´ìˆ˜</h3>
            <div class="value" id="successCount">0</div>
        </div>
        <div class="summary-card pending">
            <h3>ì§„í–‰ì¤‘ ê±´ìˆ˜</h3>
            <div class="value" id="progressCount">0</div>
        </div>
        <div class="summary-card">
            <h3>ì´ ì¶©ì „ê¸° ìˆ˜</h3>
            <div class="value" id="totalChargers">0ëŒ€</div>
        </div>
        <div class="summary-card success">
            <h3>ì›” ì˜ˆìƒ ë§¤ì¶œ</h3>
            <div class="value" id="monthlyRevenue">0ì›</div>
        </div>
        <div class="summary-card">
            <h3>ì´ ì´ˆê¸° êµ¬ì¶•ë¹„</h3>
            <div class="value" id="totalSetupFee">0ì›</div>
        </div>
    </div>
    
    <div class="table-container">
        <table id="salesTable">
            <thead>
                <tr>
                    <th style="width: 50px;">ë²ˆí˜¸</th>
                    <th style="width: 150px;">ê³ ê°ì‚¬ëª…</th>
                    <th style="width: 120px;">ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸</th>
                    <th style="width: 250px;">ì¶©ì „ê¸° ì •ë³´</th>
                    <th style="width: 120px;">ì´ˆê¸° êµ¬ì¶•ë¹„(ì›)</th>
                    <th style="width: 120px;">ì›” êµ¬ë…ë£Œ(ì›)</th>
                    <th style="width: 120px;">ì¶©ì „ê¸°ë‹¹ ë‹¨ê°€(ì›)</th>
                    <th style="width: 100px;">ì˜ì—… ë‹´ë‹¹ì</th>
                    <th style="width: 100px;">ì˜ì—… ë‹¨ê³„</th>
                    <th style="width: 120px;">ê³„ì•½ì¼</th>
                    <th style="width: 120px;">ìˆ˜ê¸ˆ ê°œì‹œì¼</th>
                    <th style="width: 120px;">ë‹´ë‹¹ì ì—°ë½ì²˜</th>
                    <th style="width: 200px;">ë¹„ê³ </th>
                    <th style="width: 80px;">ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Google Apps Script Web App URL (ë°°í¬ í›„ ì—¬ê¸°ì— ì…ë ¥)
        const SCRIPT_URL = 'https://script.google.com/a/macros/evmonit.com/s/AKfycbxJblb9T_PczvOzITR_2YeNb_Nv12glBbrShzOIRmoivVp59P8p_kCiBF5JoKLJVDYp/exec';
        
        let autoSyncInterval = null;
        let isSyncing = false;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.addEventListener('DOMContentLoaded', function() {
            if (SCRIPT_URL === 'https://script.google.com/a/macros/evmonit.com/s/AKfycbxJblb9T_PczvOzITR_2YeNb_Nv12glBbrShzOIRmoivVp59P8p_kCiBF5JoKLJVDYp/exec') {
                alert('âš ï¸ Google Apps Script URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!\n\nì„¤ì • ë°©ë²•ì€ í•¨ê»˜ ì œê³µëœ ê°€ì´ë“œ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.');
                return;
            }
            loadFromSheets();
            startAutoSync();
        });
        
        // ìë™ ë™ê¸°í™” ì‹œì‘ (30ì´ˆë§ˆë‹¤)
        function startAutoSync() {
            autoSyncInterval = setInterval(() => {
                loadFromSheets(true); // ì¡°ìš©íˆ ë¡œë“œ
            }, 30000);
        }
        
        // ë™ê¸°í™” ìƒíƒœ í‘œì‹œ
        function updateSyncStatus(status, message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = 'sync-status';
            
            switch(status) {
                case 'syncing':
                    statusEl.className += ' syncing';
                    statusEl.textContent = 'ğŸ”„ ' + message;
                    break;
                case 'synced':
                    statusEl.className += ' synced';
                    statusEl.textContent = 'âœ“ ' + message;
                    break;
                case 'error':
                    statusEl.textContent = 'âœ— ' + message;
                    break;
                default:
                    statusEl.textContent = message;
            }
        }
        
        // Google Sheetsì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadFromSheets(silent = false) {
            if (isSyncing) return;
            isSyncing = true;
            
            if (!silent) {
                document.getElementById('loadingOverlay').classList.add('show');
            }
            updateSyncStatus('syncing', 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                const response = await fetch(SCRIPT_URL + '?action=load');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('tableBody').innerHTML = '';
                    result.data.forEach(rowData => {
                        restoreRow(rowData);
                    });
                    calculateSummary();
                    updateSyncStatus('synced', 'ë™ê¸°í™” ì™„ë£Œ (' + new Date().toLocaleTimeString() + ')');
                    if (!silent) {
                        alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    throw new Error(result.message || 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Load error:', error);
                updateSyncStatus('error', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                if (!silent) {
                    alert('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + error.message);
                }
            } finally {
                isSyncing = false;
                if (!silent) {
                    document.getElementById('loadingOverlay').classList.remove('show');
                }
            }
        }
        
        // Google Sheetsì— ë°ì´í„° ì €ì¥
        async function saveToSheets() {
            if (isSyncing) {
                alert('ë™ê¸°í™” ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            isSyncing = true;
            
            document.getElementById('loadingOverlay').classList.add('show');
            updateSyncStatus('syncing', 'ë°ì´í„° ì €ì¥ ì¤‘...');
            
            try {
                const data = collectAllData();
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'save',
                        data: data
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateSyncStatus('synced', 'ì €ì¥ ì™„ë£Œ (' + new Date().toLocaleTimeString() + ')');
                    alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    throw new Error(result.message || 'ì €ì¥ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('Save error:', error);
                updateSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨');
                alert('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            } finally {
                isSyncing = false;
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        
        // ëª¨ë“  ë°ì´í„° ìˆ˜ì§‘
        function collectAllData() {
            const rows = document.querySelectorAll('#tableBody tr');
            const data = [];
            
            rows.forEach(row => {
                const cells = row.cells;
                const rowId = row.getAttribute('data-row-id');
                
                const chargers = [];
                const chargerItems = cells[3].querySelectorAll('.charger-item');
                chargerItems.forEach(item => {
                    const detailInputs = item.querySelector('.charger-details').querySelectorAll('input[type="text"]');
                    chargers.push({
                        type: item.querySelector('select').value,
                        quantity: item.querySelector('input[type="number"]').value,
                        manufacturer: detailInputs[0].value,
                        model: detailInputs[1].value
                    });
                });
                
                data.push({
                    rowId: rowId,
                    company: cells[1].querySelector('input').value,
                    businessModel: cells[2].querySelector('select').value,
                    chargers: chargers,
                    setupFee: cells[4].querySelector('input').value,
                    monthlyFee: cells[5].querySelector('input').value,
                    unitPrice: cells[6].querySelector('input').value,
                    salesPerson: cells[7].querySelector('input').value,
                    status: cells[8].querySelector('select').value,
                    contractDate: cells[9].querySelector('input').value,
                    billingStart: cells[10].querySelector('input').value,
                    contact: cells[11].querySelector('input').value,
                    note: cells[12].querySelector('textarea').value,
                    lastUpdated: new Date().toISOString()
                });
            });
            
            return data;
        }
        
        // í–‰ ë³µì›
        function restoreRow(rowData) {
            const tbody = document.getElementById('tableBody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const rowId = rowData.rowId || 'row_' + Date.now() + '_' + Math.random();
            
            const tr = document.createElement('tr');
            tr.setAttribute('data-row-id', rowId);
            
            tr.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" value="${rowData.company || ''}" placeholder="ê³ ê°ì‚¬ëª…"></td>
                <td>
                    <select onchange="handleModelChange(this)">
                        <option value="êµ¬ë…" ${rowData.businessModel === 'êµ¬ë…' ? 'selected' : ''}>êµ¬ë…</option>
                        <option value="ë…ë¦½" ${rowData.businessModel === 'ë…ë¦½' ? 'selected' : ''}>ë…ë¦½</option>
                        <option value="êµ¬ì¶•ì„ëŒ€" ${rowData.businessModel === 'êµ¬ì¶•ì„ëŒ€' ? 'selected' : ''}>êµ¬ì¶•ì„ëŒ€</option>
                        <option value="RTPS" ${rowData.businessModel === 'RTPS' ? 'selected' : ''}>RTPS</option>
                        <option value="SI" ${rowData.businessModel === 'SI' ? 'selected' : ''}>SI</option>
                        <option value="ì¶©ì „ê¸°" ${rowData.businessModel === 'ì¶©ì „ê¸°' ? 'selected' : ''}>ì¶©ì „ê¸°</option>
                        <option value="ì‹œì„¤" ${rowData.businessModel === 'ì‹œì„¤' ? 'selected' : ''}>ì‹œì„¤</option>
                    </select>
                </td>
                <td>
                    <div class="charger-list" data-row-id="${rowId}">
                        <div class="charger-summary"></div>
                        <button class="add-charger-btn" onclick="addCharger('${rowId}')">+ ì¶©ì „ê¸° ì¶”ê°€</button>
                    </div>
                </td>
                <td><input type="number" class="setupFee" value="${rowData.setupFee || ''}" placeholder="0" min="0" step="1000" onchange="calculateSummary()"></td>
                <td><input type="number" class="monthlyFee" value="${rowData.monthlyFee || ''}" placeholder="0" min="0" step="1000" onchange="calculateSummary()"></td>
                <td><input type="number" value="${rowData.unitPrice || ''}" placeholder="0" min="0" step="1000"></td>
                <td><input type="text" value="${rowData.salesPerson || ''}" placeholder="ì˜ì—… ë‹´ë‹¹ì"></td>
                <td>
                    <select onchange="calculateSummary()">
                        <option value="ì§„í–‰ì¤‘" ${rowData.status === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
                        <option value="ì„±ì‚¬" ${rowData.status === 'ì„±ì‚¬' ? 'selected' : ''}>ì„±ì‚¬</option>
                        <option value="ë³´ë¥˜" ${rowData.status === 'ë³´ë¥˜' ? 'selected' : ''}>ë³´ë¥˜</option>
                        <option value="ì·¨ì†Œ" ${rowData.status === 'ì·¨ì†Œ' ? 'selected' : ''}>ì·¨ì†Œ</option>
                    </select>
                </td>
                <td><input type="date" value="${rowData.contractDate || ''}"></td>
                <td><input type="date" value="${rowData.billingStart || ''}"></td>
                <td><input type="text" value="${rowData.contact || ''}" placeholder="010-0000-0000"></td>
                <td><textarea placeholder="ë¹„ê³ ì‚¬í•­">${rowData.note || ''}</textarea></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
            `;
            
            tbody.appendChild(tr);
            
            if (rowData.chargers && rowData.chargers.length > 0) {
                rowData.chargers.forEach(charger => {
                    addChargerWithData(rowId, charger);
                });
            }
            
            const select = tr.querySelector('select');
            handleModelChange(select);
        }
        
        function addChargerWithData(rowId, chargerData) {
            const chargerList = document.querySelector(`[data-row-id="${rowId}"]`);
            const addButton = chargerList.querySelector('.add-charger-btn');
            
            const newCharger = document.createElement('div');
            newCharger.className = 'charger-item';
            newCharger.innerHTML = `
                <select onchange="updateChargerSummary('${rowId}')">
                    <option value="ê¸‰ì†" ${chargerData.type === 'ê¸‰ì†' ? 'selected' : ''}>ê¸‰ì†</option>
                    <option value="ì™„ì†" ${chargerData.type === 'ì™„ì†' ? 'selected' : ''}>ì™„ì†</option>
                </select>
                <input type="number" value="${chargerData.quantity || 1}" placeholder="ìˆ˜ëŸ‰" min="1" oninput="updateChargerSummary('${rowId}'); calculateSummary();">
                <button class="remove-charger" onclick="removeCharger(this, '${rowId}')">ì‚­ì œ</button>
                <div class="charger-details">
                    <input type="text" value="${chargerData.manufacturer || ''}" placeholder="ì œì¡°ì‚¬" onchange="updateChargerSummary('${rowId}')">
                    <input type="text" value="${chargerData.model || ''}" placeholder="ëª¨ë¸ëª…" onchange="updateChargerSummary('${rowId}')">
                </div>
            `;
            
            chargerList.insertBefore(newCharger, addButton);
            updateChargerSummary(rowId);
        }
        
        function addRow() {
            const tbody = document.getElementById('tableBody');
            const rowCount = tbody.querySelectorAll('tr').length;
            const rowId = 'row_' + Date.now();
            
            const tr = document.createElement('tr');
            tr.setAttribute('data-row-id', rowId);
            
            tr.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="text" placeholder="ê³ ê°ì‚¬ëª…"></td>
                <td>
                    <select onchange="handleModelChange(this)">
                        <option value="êµ¬ë…">êµ¬ë…</option>
                        <option value="ë…ë¦½">ë…ë¦½</option>
                        <option value="êµ¬ì¶•ì„ëŒ€">êµ¬ì¶•ì„ëŒ€</option>
                        <option value="RTPS">RTPS</option>
                        <option value="SI">SI</option>
                        <option value="ì¶©ì „ê¸°">ì¶©ì „ê¸°</option>
                        <option value="ì‹œì„¤">ì‹œì„¤</option>
                    </select>
                </td>
                <td>
                    <div class="charger-list" data-row-id="${rowId}">
                        <div class="charger-summary">ì´ 0ëŒ€</div>
                        <button class="add-charger-btn" onclick="addCharger('${rowId}')">+ ì¶©ì „ê¸° ì¶”ê°€</button>
                    </div>
                </td>
                <td><input type="number" class="setupFee" placeholder="0" min="0" step="1000" onchange="calculateSummary()"></td>
                <td><input type="number" class="monthlyFee" placeholder="0" min="0" step="1000" onchange="calculateSummary()"></td>
                <td><input type="number" placeholder="0" min="0" step="1000"></td>
                <td><input type="text" placeholder="ì˜ì—… ë‹´ë‹¹ì"></td>
                <td>
                    <select onchange="calculateSummary()">
                        <option value="ì§„í–‰ì¤‘" selected>ì§„í–‰ì¤‘</option>
                        <option value="ì„±ì‚¬">ì„±ì‚¬</option>
                        <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                        <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                    </select>
                </td>
                <td><input type="date"></td>
                <td><input type="date"></td>
                <td><input type="text" placeholder="010-0000-0000"></td>
                <td><textarea placeholder="ë¹„ê³ ì‚¬í•­"></textarea></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">ì‚­ì œ</button></td>
            `;
            
            tbody.appendChild(tr);
            calculateSummary();
        }
        
        function addCharger(rowId) {
            const chargerList = document.querySelector(`[data-row-id="${rowId}"]`);
            const addButton = chargerList.querySelector('.add-charger-btn');
            
            const newCharger = document.createElement('div');
            newCharger.className = 'charger-item';
            newCharger.innerHTML = `
                <select onchange="updateChargerSummary('${rowId}')">
                    <option value="ê¸‰ì†">ê¸‰ì†</option>
                    <option value="ì™„ì†" selected>ì™„ì†</option>
                </select>
                <input type="number" value="1" placeholder="ìˆ˜ëŸ‰" min="1" oninput="updateChargerSummary('${rowId}'); calculateSummary();">
                <button class="remove-charger" onclick="removeCharger(this, '${rowId}')">ì‚­ì œ</button>
                <div class="charger-details">
                    <input type="text" placeholder="ì œì¡°ì‚¬" onchange="updateChargerSummary('${rowId}')">
                    <input type="text" placeholder="ëª¨ë¸ëª…" onchange="updateChargerSummary('${rowId}')">
                </div>
            `;
            
            chargerList.insertBefore(newCharger, addButton);
            updateChargerSummary(rowId);
            calculateSummary();
        }
        
        function removeCharger(btn, rowId) {
            btn.closest('.charger-item').remove();
            updateChargerSummary(rowId);
            calculateSummary();
        }
        
        function updateChargerSummary(rowId) {
            const chargerList = document.querySelector(`[data-row-id="${rowId}"]`);
            const chargerItems = chargerList.querySelectorAll('.charger-item');
            const summary = chargerList.querySelector('.charger-summary');
            
            let totalQuantity = 0;
            let fastCount = 0;
            let slowCount = 0;
            
            chargerItems.forEach(item => {
                const quantity = parseInt(item.querySelector('input[type="number"]').value) || 0;
                const type = item.querySelector('select').value;
                
                totalQuantity += quantity;
                if (type === 'ê¸‰ì†') fastCount += quantity;
                else slowCount += quantity;
            });
            
            summary.textContent = `ì´ ${totalQuantity}ëŒ€ (ê¸‰ì†: ${fastCount}ëŒ€, ì™„ì†: ${slowCount}ëŒ€)`;
        }
        
        function handleModelChange(select) {
            const row = select.closest('tr');
            const setupFeeInput = row.querySelector('.setupFee');
            const monthlyFeeInput = row.querySelector('.monthlyFee');
            
            if (select.value === 'êµ¬ë…') {
                setupFeeInput.value = '0';
                setupFeeInput.disabled = true;
                setupFeeInput.style.background = '#f5f5f5';
                monthlyFeeInput.disabled = false;
                monthlyFeeInput.style.background = 'white';
            } else if (select.value === 'ë…ë¦½') {
                monthlyFeeInput.value = '0';
                setupFeeInput.disabled = false;
                setupFeeInput.style.background = 'white';
                monthlyFeeInput.disabled = true;
                monthlyFeeInput.style.background = '#f5f5f5';
            } else {
                setupFeeInput.disabled = false;
                setupFeeInput.style.background = 'white';
                monthlyFeeInput.disabled = false;
                monthlyFeeInput.style.background = 'white';
            }
            
            calculateSummary();
        }
        
        function deleteRow(btn) {
            if (confirm('ì´ ê³ ê°ì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì„œë²„ì— ë°˜ì˜ë©ë‹ˆë‹¤.')) {
                btn.closest('tr').remove();
                calculateSummary();
            }
        }
        
        function calculateSummary() {
            const rows = document.querySelectorAll('#tableBody tr');
            let totalClients = rows.length;
            let successCount = 0;
            let progressCount = 0;
            let totalChargers = 0;
            let monthlyRevenue = 0;
            let totalSetupFee = 0;
            
            rows.forEach(row => {
                const cells = row.cells;
                const status = cells[8].querySelector('select').value;
                const setupFee = parseInt(cells[4].querySelector('input').value) || 0;
                const monthlyFee = parseInt(cells[5].querySelector('input').value) || 0;
                
                const chargerItems = cells[3].querySelectorAll('.charger-item');
                let rowChargers = 0;
                chargerItems.forEach(item => {
                    rowChargers += parseInt(item.querySelector('input[type="number"]').value) || 0;
                });
                totalChargers += rowChargers;
                
                if (status === 'ì„±ì‚¬') {
                    successCount++;
                    monthlyRevenue += monthlyFee;
                    totalSetupFee += setupFee;
                } else if (status === 'ì§„í–‰ì¤‘') {
                    progressCount++;
                }
            });
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('progressCount').textContent = progressCount;
            document.getElementById('totalChargers').textContent = totalChargers + 'ëŒ€';
            document.getElementById('monthlyRevenue').textContent = monthlyRevenue.toLocaleString() + 'ì›';
            document.getElementById('totalSetupFee').textContent = totalSetupFee.toLocaleString() + 'ì›';
        }
        
        function exportToExcel() {
            const table = document.getElementById('salesTable');
            const rows = table.querySelectorAll('tbody tr');
            
            const data = [
                ['ë²ˆí˜¸', 'ê³ ê°ì‚¬ëª…', 'ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸', 'ì¶©ì „ê¸° íƒ€ì…', 'ì œì¡°ì‚¬', 'ëª¨ë¸ëª…', 'ìˆ˜ëŸ‰', 
                 'ì´ˆê¸° êµ¬ì¶•ë¹„(ì›)', 'ì›” êµ¬ë…ë£Œ(ì›)', 'ì¶©ì „ê¸°ë‹¹ ë‹¨ê°€(ì›)', 'ì˜ì—… ë‹´ë‹¹ì', 'ì˜ì—… ë‹¨ê³„', 
                 'ê³„ì•½ì¼', 'ìˆ˜ê¸ˆ ê°œì‹œì¼', 'ë‹´ë‹¹ì ì—°ë½ì²˜', 'ë¹„ê³ ']
            ];
            
            let rowNum = 1;
            rows.forEach(row => {
                const cells = row.cells;
                const company = cells[1].querySelector('input').value;
                const model = cells[2].querySelector('select').value;
                const setupFee = cells[4].querySelector('input').value;
                const monthlyFee = cells[5].querySelector('input').value;
                const unitPrice = cells[6].querySelector('input').value;
                const sales = cells[7].querySelector('input').value;
                const status = cells[8].querySelector('select').value;
                const contractDate = cells[9].querySelector('input').value;
                const billingStart = cells[10].querySelector('input').value;
                const contact = cells[11].querySelector('input').value;
                const note = cells[12].querySelector('textarea').value;
                
                const chargerItems = cells[3].querySelectorAll('.charger-item');
                
                if (chargerItems.length === 0) {
                    data.push([rowNum++, company, model, '', '', '', '', setupFee, monthlyFee, unitPrice, 
                              sales, status, contractDate, billingStart, contact, note]);
                } else {
                    chargerItems.forEach((item, index) => {
                        const quantity = item.querySelector('input[type="number"]').value;
                        const type = item.querySelector('select').value;
                        const detailInputs = item.querySelector('.charger-details').querySelectorAll('input[type="text"]');
                        const manufacturer = detailInputs[0].value;
                        const chargerModel = detailInputs[1].value;
                        
                        if (index === 0) {
                            data.push([rowNum++, company, model, type, manufacturer, chargerModel, quantity,
                                      setupFee, monthlyFee, unitPrice, sales, status, contractDate, 
                                      billingStart, contact, note]);
                        } else {
                            data.push(['', '', '', type, manufacturer, chargerModel, quantity, '', '', '', 
                                      '', '', '', '', '', '']);
                        }
                    });
                }
            });
            
            data.push([]);
            data.push(['=== ì˜ì—… í˜„í™© ì§‘ê³„ ===']);
            data.push(['ì „ì²´ ê³ ê°ì‚¬', document.getElementById('totalClients').textContent]);
            data.push(['ì„±ì‚¬ ê±´ìˆ˜', document.getElementById('successCount').textContent]);
            data.push(['ì§„í–‰ì¤‘ ê±´ìˆ˜', document.getElementById('progressCount').textContent]);
            data.push(['ì´ ì¶©ì „ê¸° ìˆ˜', document.getElementById('totalChargers').textContent]);
            data.push(['ì›” ì˜ˆìƒ ë§¤ì¶œ', document.getElementById('monthlyRevenue').textContent]);
            data.push(['ì´ ì´ˆê¸° êµ¬ì¶•ë¹„', document.getElementById('totalSetupFee').textContent]);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            ws['!cols'] = [
                {wch: 6}, {wch: 20}, {wch: 12}, {wch: 10}, {wch: 15}, 
                {wch: 15}, {wch: 8}, {wch: 15}, {wch: 15}, {wch: 15}, 
                {wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 30}
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì˜ì—…í˜„í™©');
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `ì „ê¸°ì°¨ì¶©ì „ê´€ì œ_ì˜ì—…í˜„í™©_${date}.xlsx`);
        }
    </script>
</body>
</html>
